name: Cricket App CI

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ Checkout code
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'  # match your local Flutter version
          channel: 'stable'

      # 3Ô∏è‚É£ Clean previous build (safe for CI)
      - name: Clean Flutter build
        run: flutter clean

      # 4Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: flutter pub get

      # 5Ô∏è‚É£ Run build_runner to generate files
      - name: Run build_runner
        run: flutter pub run build_runner build --delete-conflicting-outputs

      # 6Ô∏è‚É£ Create dummy .env file if needed
      - name: Create dummy env file
        run: New-Item -Path .env -ItemType File -Force

      # 7Ô∏è‚É£ Copy CI key.properties (with placeholders)
      - name: Setup key.properties for CI
        run: copy android/key.properties.ci android/key.properties

      # 8Ô∏è‚É£ Setup Keystore from base64 secret
      - name: Setup Keystore
        run: |
          # Create android/app folder if missing
          if (-not (Test-Path "android/app")) {
            New-Item -ItemType Directory -Path "android/app"
          }

          # Decode base64 secret into JKS keystore
          [System.IO.File]::WriteAllBytes(
            "android/app/my-release-key-new.jks",
            [System.Convert]::FromBase64String("${{ secrets.KEYSTORE_BASE64 }}")
          )

      # 9Ô∏è‚É£ Optional: Debug keystore exists
      - name: Debug keystore
        run: dir android\app

      # üîü Build AppBundle (verbose)
      - name: Build AppBundle (verbose)
        run: flutter build appbundle --release -v
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
