name: Cricket App CI

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Flutter (pin version to match your local)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'

      # 3Ô∏è‚É£ Flutter version (optional, debug)
      - name: Flutter version
        run: flutter --version

      # 4Ô∏è‚É£ Clean any previous build (safe step for CI)
      - name: Clean Flutter build
        run: flutter clean

      # 5Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: flutter pub get

      # 6Ô∏è‚É£ Run build_runner to generate files
      - name: Run build_runner
        run: flutter pub run build_runner build --delete-conflicting-outputs

      # 7Ô∏è‚É£ Create dummy .env file if needed
      - name: Create dummy env file
        run: New-Item -Path .env -ItemType File -Force

      # 8Ô∏è‚É£ Copy CI-specific key.properties
      - name: Setup key.properties for CI
        run: copy android/key.properties.ci android/key.properties

      # 9Ô∏è‚É£ Setup Keystore safely
      - name: Setup Keystore
        run: |
          # Create android/app folder only if missing
          if (-not (Test-Path "android/app")) {
            New-Item -ItemType Directory -Path "android/app"
          }

          # Write keystore from base64 secret
          [System.IO.File]::WriteAllBytes(
            "android/app/my-release-key-new.jks",
            [System.Convert]::FromBase64String("${{ secrets.KEYSTORE_BASE64 }}")
          )

      # üîü Debug keystore exists
      - name: Debug keystore
        run: dir android\app

      # 1Ô∏è‚É£1Ô∏è‚É£ Build AppBundle (verbose for CI logs)
      - name: Build AppBundle (verbose)
        run: flutter build appbundle --release -v
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
